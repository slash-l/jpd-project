## 为什需要状态管理
Terraform 的主要作用是管理云平台上的资源，通过声明式的 HCL 配置来映射资源，如果云平台上没有资源则需要创建，如果有则不用。那 Terraform 要实现这个功能有多种方式。

一种是每次执行 apply 命令时都调用 API 接口检查一下远程的云资源是否与配置文件一致，如果没有则创建，如果有但不同则需要修改，如果有且相同则不用变更。这种机制能保证云平台的资源与 HCL 配置是一致的。缺点也是非常明显的，每次都需要调用 API 去检查远程资源，效率很低，特别是当资源特别多的场景。

另一种方式是每次变更资源的时候，都会创建一个映射文件，它保存云平台资源的状态。这样每次执行 apply 命令时，只需要检查 HCL 配置与映射文件的差异即可。

## Terraform 状态文件
Terraform 选择的是第二种方式，通过映射文件来保存资源状态，在 Terraform 的世界里叫状态文件。Terraform 这样做是基于以下考虑：

云平台真实状态的映射，解析状态文件即可以知道真实情况。
元数据存储，如资源之间的依赖关系，需要通过依赖关系来知道创建或销毁顺序。
提升性能，特别是在大规模云平台上，多次调用API去查询资源状态是很费时的。
同步状态，通过远程状态文件来同步状态，这也是 Terraform 最佳的实践。

## 状态文件作用和工作原理
|  操作   | 现象及说明  |
|  ----  | ----  |
| terraform apply  | 生成资源：第一次生成 |
| terraform apply  | 没有变化：状态文件生成，不需要再创建 |
| terraform destroy | 删除资源：根据状态文件的内容删除 |
| terraform apply | 生成资源：状态显示没有资源，再次生成 |
| 删除状态文件 | 没有变化 |
| terraform apply | 生成资源：没有状态文件，直接生成资源和状态文件（插件做了容错处理，已存在也会新生成覆盖） |
| 删除状态文件 | 没有变化 |
| terraform destroy | 无法删除资源，没有资源存在的状态 |

## Backend
状态文件默认是在本地目录上的 terraform.tfstate 文件，在团队使用中，每个人的电脑环境独立的，那么需要保证每个人当前的状态文件都是最新且与现实资源真实对应，简直是天方夜谭。而状态不一致所带的灾难也是极其可怕的。所以，状态文件最好是要存储在一个独立的大家可共同访问的位置。对于状态的管理的配置，Terraform 称之为 Backend




