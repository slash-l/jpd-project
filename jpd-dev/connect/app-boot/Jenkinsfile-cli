pipeline {
    agent any
    tools {
        jfrog 'jfrog-cli-demojfrogchina'
        // jfrog 'jfrog-cli-solengjfrog'
    }
    stages {
        stage('Testing') {
            steps {
                // Show the installed version of JFrog CLI.
                jf '-v'

                // Show the configured JFrog Platform instances.
                jf 'c show'

                // jf 'c use solengjfrog'

                // Ping Artifactory.
                jf 'rt ping'

                sh 'export JFROG_CLI_RELEASES_REPO'
            }
        }

        stage('Clone') {
            steps {
                git url: 'https://gitee.com/mumu79/app-kubernetes.git', branch: 'main'
            }
        }

        stage('Exec Maven commands') {
            steps {
                dir('app-boot') {
                    // Configure Maven project's repositories
                    jf 'mvn-config --repo-resolve-releases slash-maven-virtual --repo-resolve-snapshots slash-maven-virtual --repo-deploy-releases slash-maven-test-local --repo-deploy-snapshots slash-maven-test-local'

                    // Install and publish project
                    jf 'mvn install -Drevision=1.2.' + env.BUILD_NUMBER
                }
            }
        }

        stage('Publish build info') {
            steps {
                dir('app-boot') {
                    jf 'rt build-publish ' + env.JOB_NAME  + ' ' + env.BUILD_NUMBER
                }
            }
        }

        stage('Xray scan') {
            steps {
                jf 'bs ' + env.JOB_NAME  + ' ' + env.BUILD_NUMBER + ' --fail=true'
            }
        }

        stage('Promotion') {
            steps {
                echo "Promote to release repo"
                echo env.JOB_NAME
                echo env.BUILD_NUMBER

                jf 'rt bpr ' + env.JOB_NAME  + ' ' + env.BUILD_NUMBER  + ' slash-maven-release-local --status=RELEASE --comment=Release_App_boot --source-repo=slash-maven-test-local'

            }
        }
        
        stage('Set to release') {
            steps {
                sleep time: 2, unit: 'SECONDS' // 暂停 2 秒，等待晋级完成

                // Install and publish project
                jf 'rt sp slash-maven-release-local/vacuum_robot/v' + env.BUILD_NUMBER + '/simulated_vacuum_robot.py v' + env.BUILD_NUMBER + '=version'
            }
        }

    }
}
